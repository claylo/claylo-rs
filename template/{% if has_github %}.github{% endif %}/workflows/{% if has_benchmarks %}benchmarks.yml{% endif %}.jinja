{% raw %}name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_gungraun:
        description: 'Skip gungraun benchmarks'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Divan benchmarks run on all platforms
  divan:
    name: Divan (wall-clock)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Generate benchmark harnesses
        run: cargo xtask gen-benchmarks

      - name: Run Divan benchmarks
        run: |
          mkdir -p bench-reports
          cargo bench --bench divan_benchmarks 2>&1 | tee bench-reports/divan-ci.txt

      - name: Upload Divan results
        uses: actions/upload-artifact@v6
        with:
          name: divan-results
          path: bench-reports/divan-ci.txt
          retention-days: 30

  # Gungraun requires Valgrind (Linux only, no ARM64)
  gungraun:
    name: Gungraun (instruction count)
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_gungraun }}

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install gungraun-runner
        uses: ./.github/actions/setup-cargo-tools
        with:
          binstall-tools: gungraun-runner

      - name: Generate benchmark harnesses
        run: cargo xtask gen-benchmarks

      - name: Run Gungraun benchmarks
        run: |
          mkdir -p bench-reports
          cargo bench --bench gungraun_benchmarks 2>&1 | tee bench-reports/gungraun-ci.txt

      - name: Upload Gungraun results
        uses: actions/upload-artifact@v6
        with:
          name: gungraun-results
          path: bench-reports/gungraun-ci.txt
          retention-days: 30

  # CLI benchmarks with hyperfine
  cli:
    name: CLI (hyperfine)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install hyperfine
        run: |
          wget -q https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run CLI benchmarks
        run: |
          chmod +x ./scripts/bench-cli.sh
          ./scripts/bench-cli.sh --quick

      - name: Upload CLI benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: cli-benchmark-results
          path: bench-reports/
          retention-days: 30

  # Summary job that collects all results
  summary:
    name: Benchmark Summary
    runs-on: ubuntu-latest
    needs: [divan, gungraun, cli]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-results

      - name: Create summary
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f all-results/divan-results/divan-ci.txt ]; then
            echo "### Divan (Wall-Clock)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 all-results/divan-results/divan-ci.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-results/gungraun-results/gungraun-ci.txt ]; then
            echo "### Gungraun (Instruction Count)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 all-results/gungraun-results/gungraun-ci.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-results/cli-benchmark-results/hyperfine-startup.md ]; then
            echo "### CLI (Hyperfine)" >> $GITHUB_STEP_SUMMARY
            cat all-results/cli-benchmark-results/hyperfine-startup.md >> $GITHUB_STEP_SUMMARY
          fi
{% endraw %}
