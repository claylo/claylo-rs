//! Library interface for the `{{ project_name }}` CLI.
//!
//! This crate exposes the CLI's argument parser and command structure as a library,
//! primarily for documentation generation and testing. The actual entry point is
//! in `main.rs`.
//!
//! # Structure
//!
//! - [`Cli`] - The root argument parser (clap derive)
//! - [`Commands`] - Available subcommands
//! - [`commands`] - Command implementations
//!
//! # Documentation Generation
//!
//! The [`command()`] function returns the clap `Command` for generating man pages
//! and shell completions via `xtask`.
{% if has_config and not has_core_library %}
pub mod config;
{% endif %}
pub mod commands;
{% if has_mcp_server %}
pub mod server;
{% endif %}

use clap::{CommandFactory, Parser, Subcommand};
use std::path::PathBuf;

/// Color output preference.
#[derive(Debug, Clone, Copy, Default, clap::ValueEnum)]
pub enum ColorChoice {
    /// Detect terminal capabilities automatically.
    #[default]
    Auto,
    /// Always emit colors.
    Always,
    /// Never emit colors.
    Never,
}

impl ColorChoice {
    /// Configure global color output based on this choice.
    ///
    /// Call this once at startup to set the color mode.
    pub fn apply(self) {
        match self {
            Self::Auto => {} // owo-colors auto-detects by default
            Self::Always => owo_colors::set_override(true),
            Self::Never => owo_colors::set_override(false),
        }
    }
}

{% if has_jsonl_logging or has_opentelemetry -%}
{% if has_opentelemetry -%}
const ENV_HELP: &str = "\
ENVIRONMENT VARIABLES:
    RUST_LOG                            Log filter (e.g., debug, {{ project_name }}=trace)
    {{ project_name | upper | replace('-', '_') }}_LOG_PATH                 Explicit log file path
    {{ project_name | upper | replace('-', '_') }}_LOG_DIR                  Log directory
    {{ project_name | upper | replace('-', '_') }}_ENV                      Environment (dev, staging, prod)
    OTEL_EXPORTER_OTLP_ENDPOINT         OTLP endpoint (enables tracing)
    OTEL_EXPORTER_OTLP_PROTOCOL         Protocol: grpc (default), http/json
";
{% else -%}
const ENV_HELP: &str = "\
ENVIRONMENT VARIABLES:
    RUST_LOG                Log filter (e.g., debug, {{ project_name }}=trace)
    {{ project_name | upper | replace('-', '_') }}_LOG_PATH     Explicit log file path
    {{ project_name | upper | replace('-', '_') }}_LOG_DIR      Log directory
";
{% endif -%}
{% endif -%}

/// Command-line interface definition for {{ project_name }}.
#[derive(Parser)]
#[command(name = "{{ project_name }}")]
#[command(about = "{{ project_description }}", long_about = None)]
#[command(version)]
{% if has_jsonl_logging or has_opentelemetry -%}
#[command(after_long_help = ENV_HELP)]
{% endif -%}
pub struct Cli {
    /// The subcommand to execute.
    #[command(subcommand)]
    pub command: Commands,
{% if has_config %}
    /// Path to configuration file (overrides discovery)
    #[arg(short, long, global = true, value_name = "FILE")]
    pub config: Option<PathBuf>,
{% endif %}
    /// Run as if started in DIR
    #[arg(short = 'C', long, global = true)]
    pub chdir: Option<PathBuf>,

    /// Only print errors (suppresses warnings/info)
    #[arg(short, long, global = true)]
    pub quiet: bool,

    /// More detail (repeatable; e.g. -vv)
    #[arg(short, long, global = true, action = clap::ArgAction::Count)]
    pub verbose: u8,

    /// Colorize output
    #[arg(long, global = true, value_enum, default_value_t)]
    pub color: ColorChoice,

    /// Output as JSON (for scripting)
    #[arg(long, global = true)]
    pub json: bool,
}

/// Available subcommands for the CLI.
#[derive(Subcommand)]
pub enum Commands {
{% if has_config %}
    /// Diagnose configuration and environment
    Doctor(commands::doctor::DoctorArgs),
{% endif %}
    /// Show package information
    Info(commands::info::InfoArgs),
{% if has_mcp_server %}
    /// Start MCP (Model Context Protocol) server on stdio
    Serve(commands::serve::ServeArgs),
{% endif %}
}

/// Returns the clap command for documentation generation
pub fn command() -> clap::Command {
    Cli::command()
}
